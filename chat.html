<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Corporativo - Sala</title>
  <link rel="stylesheet" href="anarcroom.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-logo">
        <img src="374762a1-c03d-478c-acde-97469eea0fa3.png" alt="Logo">
      </div>
      <h1>Chat Corporativo</h1>
      <p id="roomLabel" class="tagline"></p>
    </div>
    
    <div id="joinSection" class="section">
      <h2>Bem-vindo √† Sala</h2>
      <div class="form-group">
        <label for="user">Nome de Utilizador:</label>
        <input type="text" id="user" placeholder="Insira seu nome" autocomplete="off" required>
      </div>
      <button onclick="entrar()" style="width: 100%;">Entrar na Sala</button>
    </div>
    
    <div id="chat" style="display: none;">
      <div class="status">
        <span id="userDisplay"></span> | <span id="onlineCount">0</span> utilizadores online
      </div>
      
      <div id="messages"></div>
      
      <div class="section">
        <div class="form-group">
          <label for="msg">Sua Mensagem:</label>
          <div class="input-wrapper">
            <input id="msg" type="text" placeholder="Escreva sua mensagem..." autocomplete="off" required>
            <button onclick="enviar()">Enviar</button>
          </div>
        </div>
      </div>
      
      <div class="section" style="text-align: center;">
        <a href="index.html">‚Üê Voltar ao In√≠cio</a>
      </div>
    </div>
  </div>

  <script>
    // Chat em Tempo Real - Broadcast Channel API + localStorage
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room') || 'default';
    document.getElementById('roomLabel').textContent = 'Sala: ' + room.toUpperCase();

    let username = '';
    let bc = null;
    let pollInterval = null;

    // Broadcast Channel para tempo real entre abas
    if (typeof BroadcastChannel !== 'undefined') {
      bc = new BroadcastChannel('chat_room_' + room);
      bc.onmessage = (event) => {
        if (event.data.type === 'newMessage') {
          loadMessages();
          updateOnlineCount();
        } else if (event.data.type === 'userJoined') {
          updateOnlineCount();
        }
      };
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function storageKey(r) { return 'anarchroom_msgs_' + r; }

    function loadMessages() {
      const container = document.getElementById('messages');
      const raw = localStorage.getItem(storageKey(room));
      let msgs = [];
      try { msgs = raw ? JSON.parse(raw) : []; } catch(e){ msgs = []; }

      container.innerHTML = '';
      
      if (!msgs.length) {
        const p = document.createElement('p');
        p.textContent = '(Sem mensagens ainda)';
        p.style.color = '#a0aec0';
        p.style.textAlign = 'center';
        p.style.fontStyle = 'italic';
        container.appendChild(p);
        return;
      }

      msgs.sort((a,b)=> a.time - b.time).forEach(m => {
        const p = document.createElement('p');
        const t = formatTime(m.time);
        p.innerHTML = `<span class="message-time">[${t}]</span> <strong>${m.user}:</strong> ${m.msg}`;
        container.appendChild(p);
      });
      container.scrollTop = container.scrollHeight;
    }

    function updateOnlineCount() {
      const key = 'anarchroom_users_' + room;
      const users = JSON.parse(localStorage.getItem(key) || '{}');
      const now = Date.now();
      const timeout = 45000;
      
      Object.keys(users).forEach(user => {
        if(now - users[user] > timeout) {
          delete users[user];
        }
      });
      
      localStorage.setItem(key, JSON.stringify(users));
      document.getElementById('onlineCount').textContent = Object.keys(users).length;
    }

    function updateHeartbeat() {
      if (username) {
        const key = 'anarchroom_users_' + room;
        const users = JSON.parse(localStorage.getItem(key) || '{}');
        users[username] = Date.now();
        localStorage.setItem(key, JSON.stringify(users));
        updateOnlineCount();
        
        if (bc) {
          bc.postMessage({ type: 'heartbeat', user: username });
        }
      }
    }

    window.entrar = function() {
      username = document.getElementById('user').value.trim();
      if (!username) {
        alert('Por favor, insira um nome de utilizador');
        return;
      }

      const key = 'anarchroom_users_' + room;
      const users = JSON.parse(localStorage.getItem(key) || '{}');
      users[username] = Date.now();
      localStorage.setItem(key, JSON.stringify(users));

      document.getElementById('joinSection').style.display = 'none';
      document.getElementById('chat').style.display = 'block';
      document.getElementById('userDisplay').textContent = 'üë§ ' + username;
      
      loadMessages();
      updateOnlineCount();

      if (bc) {
        bc.postMessage({ type: 'userJoined', user: username });
      }
      
      pollInterval = setInterval(() => {
        updateHeartbeat();
        loadMessages();
      }, 800);
      
      setInterval(updateHeartbeat, 10000);

      document.getElementById('msg').focus();
    };

    window.enviar = function() {
      const txt = document.getElementById('msg').value.trim();
      if (!txt) return;

      const raw = localStorage.getItem(storageKey(room));
      let msgs = [];
      try { msgs = raw ? JSON.parse(raw) : []; } catch(e){ msgs = []; }

      const newMsg = { user: username, msg: txt, time: Date.now() };
      msgs.push(newMsg);
      
      try { 
        localStorage.setItem(storageKey(room), JSON.stringify(msgs)); 
      } catch(e){ 
        alert('Erro ao gravar: ' + e.message); 
        return;
      }

      if (bc) {
        bc.postMessage({ type: 'newMessage', room: room, message: newMsg });
      }

      document.getElementById('msg').value = '';
      loadMessages();
      document.getElementById('msg').focus();
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement.id === 'msg') {
        e.preventDefault();
        enviar();
      }
    });

    window.addEventListener('storage', (e) => {
      if (e.key === 'anarchroom_msgs_' + room || e.key === 'anarchroom_users_' + room) {
        loadMessages();
        updateOnlineCount();
      }
    });

    window.addEventListener('beforeunload', () => {
      if(username) {
        const key = 'anarchroom_users_' + room;
        const users = JSON.parse(localStorage.getItem(key) || '{}');
        delete users[username];
        localStorage.setItem(key, JSON.stringify(users));
        if(bc) bc.close();
      }
      if(pollInterval) clearInterval(pollInterval);
    });

    pollInterval = setInterval(() => {
      loadMessages();
      updateOnlineCount();
    }, 1000);
  </script>
</body>
</html>
